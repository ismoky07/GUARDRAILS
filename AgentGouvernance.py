import os
import re
import sys
import time
from typing import Dict, List, Any
from dataclasses import dataclass
from textwrap import dedent
from dotenv import load_dotenv
from agno.agent import Agent
from agno.models.xai import xAI

load_dotenv()

@dataclass
class GovernancePolicy:
    """Structure pour stocker les politiques de gouvernance"""
    id: str
    name: str
    category: str
    description: str
    rules: List[str]
    boundaries: List[str]
    enforcement_level: str
    created_at: float
    updated_at: float

@dataclass
class AgentPurpose:
    """Structure pour d√©finir le but et les cas d'usage de l'agent"""
    agent_id: str
    name: str
    primary_purpose: str
    authorized_use_cases: List[str]
    prohibited_use_cases: List[str]
    capabilities: List[str]
    limitations: List[str]
    boundaries: List[str]
    created_at: float

class GovernanceTools:
    """Outils de gouvernance pour les 2 mesures principales"""
    
    def __init__(self):
        # Politiques de gouvernance par d√©faut
        self.policies = {}
        self.agent_purposes = {}
        self.enforcement_log = []
        
        # Comportements par d√©faut
        self.default_behaviors = {
            'response_style': 'professional',
            'safety_level': 'high',
            'transparency': 'full',
            'accountability': 'enabled',
            'audit_trail': 'enabled'
        }
        
        # Limites d'action par d√©faut
        self.default_boundaries = {
            'max_response_length': 5000,
            'max_processing_time': 30,
            'max_api_calls': 10,
            'max_file_size': 10,  # MB
            'allowed_domains': ['*'],
            'prohibited_content': ['illegal', 'harmful', 'discriminatory']
        }
        
        # Initialiser les politiques par d√©faut
        self._initialize_default_policies()
    
    def _initialize_default_policies(self):
        """Initialise les politiques de gouvernance par d√©faut"""
        
        # Politique de s√©curit√©
        security_policy = GovernancePolicy(
            id="security_001",
            name="Politique de S√©curit√©",
            category="security",
            description="Politique de s√©curit√© pour la protection des donn√©es et des utilisateurs",
            rules=[
                "Ne jamais exposer d'informations sensibles",
                "Toujours valider les entr√©es utilisateur",
                "Utiliser des connexions s√©curis√©es uniquement",
                "Chiffrer les donn√©es sensibles en transit et au repos"
            ],
            boundaries=[
                "Acc√®s limit√© aux donn√©es autoris√©es uniquement",
                "Aucun acc√®s aux syst√®mes de production sans autorisation",
                "Audit obligatoire de toutes les actions sensibles"
            ],
            enforcement_level="critical",
            created_at=time.time(),
            updated_at=time.time()
        )
        
        # Politique de conformit√©
        compliance_policy = GovernancePolicy(
            id="compliance_001",
            name="Politique de Conformit√©",
            category="compliance",
            description="Politique de conformit√© pour respecter les r√©glementations",
            rules=[
                "Respecter le RGPD pour les donn√©es personnelles",
                "Respecter les lois locales et internationales",
                "Maintenir la tra√ßabilit√© des actions",
                "Signaler les violations de conformit√©"
            ],
            boundaries=[
                "Aucune utilisation de donn√©es sans consentement",
                "Respect des d√©lais de r√©tention des donn√©es",
                "Notification obligatoire des violations"
            ],
            enforcement_level="high",
            created_at=time.time(),
            updated_at=time.time()
        )
        
        # Politique de qualit√©
        quality_policy = GovernancePolicy(
            id="quality_001",
            name="Politique de Qualit√©",
            category="quality",
            description="Politique de qualit√© pour maintenir l'excellence des services",
            rules=[
                "Fournir des r√©ponses pr√©cises et v√©rifi√©es",
                "Admettre les limitations et incertitudes",
                "Citer les sources quand appropri√©",
                "Maintenir un niveau de service constant"
            ],
            boundaries=[
                "Ne jamais inventer d'informations",
                "Limiter les r√©ponses aux domaines d'expertise",
                "Escalader les questions complexes"
            ],
            enforcement_level="medium",
            created_at=time.time(),
            updated_at=time.time()
        )
        
        self.policies = {
            security_policy.id: security_policy,
            compliance_policy.id: compliance_policy,
            quality_policy.id: quality_policy
        }
    
    def define_agent_purpose(self, agent_id: str, name: str, primary_purpose: str, 
                           authorized_use_cases: List[str], prohibited_use_cases: List[str] = None,
                           capabilities: List[str] = None, limitations: List[str] = None) -> AgentPurpose:
        """D√©finit le but et les cas d'usage d'un agent"""
        
        purpose = AgentPurpose(
            agent_id=agent_id,
            name=name,
            primary_purpose=primary_purpose,
            authorized_use_cases=authorized_use_cases,
            prohibited_use_cases=prohibited_use_cases or [],
            capabilities=capabilities or [],
            limitations=limitations or [],
            boundaries=self.default_boundaries.copy(),
            created_at=time.time()
        )
        
        self.agent_purposes[agent_id] = purpose
        
        print(f"üéØ Mesure But de l'agent d√©fini: {name}")
        print(f"üìã Mesure Cas d'usage autoris√©s: {len(authorized_use_cases)}")
        print(f"üö´ Mesure Cas d'usage interdits: {len(prohibited_use_cases or [])}")
        
        return purpose
    
    def set_default_behavior(self, behavior_type: str, value: Any) -> None:
        """D√©finit un comportement par d√©faut"""
        if behavior_type in self.default_behaviors:
            self.default_behaviors[behavior_type] = value
            print(f"‚öôÔ∏è Mesure Comportement par d√©faut mis √† jour: {behavior_type} = {value}")
        else:
            print(f"‚ùå Mesure Type de comportement non reconnu: {behavior_type}")
    
    def set_boundary(self, boundary_type: str, value: Any) -> None:
        """D√©finit une limite d'action"""
        if boundary_type in self.default_boundaries:
            self.default_boundaries[boundary_type] = value
            print(f"üîí Mesure Limite mise √† jour: {boundary_type} = {value}")
        else:
            print(f"‚ùå Mesure Type de limite non reconnu: {boundary_type}")
    
    def add_policy(self, policy: GovernancePolicy) -> None:
        """Ajoute une nouvelle politique de gouvernance"""
        self.policies[policy.id] = policy
        print(f"üìú Mesure Politique ajout√©e: {policy.name}")
    
    def update_policy(self, policy_id: str, updates: Dict[str, Any]) -> None:
        """Met √† jour une politique existante"""
        if policy_id in self.policies:
            policy = self.policies[policy_id]
            for key, value in updates.items():
                if hasattr(policy, key):
                    setattr(policy, key, value)
            policy.updated_at = time.time()
            print(f"üìù Mesure Politique mise √† jour: {policy.name}")
        else:
            print(f"‚ùå Mesure Politique non trouv√©e: {policy_id}")
    
    def check_authorization(self, agent_id: str, action: str, context: Dict[str, Any] = None) -> Dict[str, Any]:
        """V√©rifie si une action est autoris√©e pour un agent"""
        if agent_id not in self.agent_purposes:
            return {
                'authorized': False,
                'reason': 'Agent non enregistr√©',
                'recommendation': 'Enregistrer l\'agent avec define_agent_purpose'
            }
        
        purpose = self.agent_purposes[agent_id]
        context = context or {}
        
        # V√©rifier les cas d'usage interdits
        for prohibited in purpose.prohibited_use_cases:
            if prohibited.lower() in action.lower():
                self._log_enforcement(agent_id, action, False, f"Cas d'usage interdit: {prohibited}")
                return {
                    'authorized': False,
                    'reason': f'Cas d\'usage interdit: {prohibited}',
                    'recommendation': 'Utiliser un cas d\'usage autoris√©'
                }
        
        # V√©rifier les limites
        if 'max_response_length' in self.default_boundaries:
            if len(action) > self.default_boundaries['max_response_length']:
                self._log_enforcement(agent_id, action, False, "D√©passement de la limite de longueur")
                return {
                    'authorized': False,
                    'reason': 'D√©passement de la limite de longueur de r√©ponse',
                    'recommendation': 'R√©duire la longueur de la requ√™te'
                }
        
        # V√©rifier les politiques applicables
        for policy in self.policies.values():
            if self._check_policy_violation(policy, action, context):
                self._log_enforcement(agent_id, action, False, f"Violation de politique: {policy.name}")
                return {
                    'authorized': False,
                    'reason': f'Violation de la politique: {policy.name}',
                    'recommendation': 'Respecter les r√®gles de la politique'
                }
        
        # Action autoris√©e
        self._log_enforcement(agent_id, action, True, "Action autoris√©e")
        return {
            'authorized': True,
            'reason': 'Action conforme aux politiques',
            'recommendation': 'Continuer l\'ex√©cution'
        }
    
    def _check_policy_violation(self, policy: GovernancePolicy, action: str, context: Dict[str, Any]) -> bool:
        """V√©rifie si une action viole une politique"""
        # V√©rifier les r√®gles de la politique
        for rule in policy.rules:
            if self._check_rule_violation(rule, action, context):
                return True
        
        # V√©rifier les limites de la politique
        for boundary in policy.boundaries:
            if self._check_boundary_violation(boundary, action, context):
                return True
        
        return False
    
    def _check_rule_violation(self, rule: str, action: str, context: Dict[str, Any]) -> bool:
        """V√©rifie si une r√®gle est viol√©e"""
        # Logique simple de v√©rification - peut √™tre √©tendue
        rule_lower = rule.lower()
        action_lower = action.lower()
        
        if "ne jamais" in rule_lower and "exposer" in rule_lower:
            return "password" in action_lower or "secret" in action_lower
        
        if "toujours valider" in rule_lower:
            return not self._is_valid_input(action)
        
        return False
    
    def _check_boundary_violation(self, boundary: str, action: str, context: Dict[str, Any]) -> bool:
        """V√©rifie si une limite est viol√©e"""
        boundary_lower = boundary.lower()
        action_lower = action.lower()
        
        if "acc√®s limit√©" in boundary_lower:
            return "admin" in action_lower or "root" in action_lower
        
        if "aucun acc√®s" in boundary_lower:
            return "production" in action_lower or "syst√®me" in action_lower
        
        return False
    
    def _is_valid_input(self, input_text: str) -> bool:
        """Valide une entr√©e utilisateur"""
        # Logique de validation simple - peut √™tre √©tendue
        if not input_text or len(input_text.strip()) == 0:
            return False
        
        if len(input_text) > 10000:  # Limite de longueur
            return False
        
        return True
    
    def _log_enforcement(self, agent_id: str, action: str, authorized: bool, reason: str):
        """Enregistre une action d'application des politiques"""
        log_entry = {
            'timestamp': time.time(),
            'agent_id': agent_id,
            'action': action,
            'authorized': authorized,
            'reason': reason
        }
        self.enforcement_log.append(log_entry)
        
        # Garder seulement les 1000 derni√®res entr√©es
        if len(self.enforcement_log) > 1000:
            self.enforcement_log = self.enforcement_log[-1000:]
    
    def get_governance_report(self) -> Dict[str, Any]:
        """G√©n√®re un rapport de gouvernance complet"""
        total_policies = len(self.policies)
        total_agents = len(self.agent_purposes)
        total_enforcements = len(self.enforcement_log)
        
        authorized_actions = sum(1 for log in self.enforcement_log if log['authorized'])
        denied_actions = total_enforcements - authorized_actions
        
        report = {
            'total_policies': total_policies,
            'total_agents': total_agents,
            'total_enforcements': total_enforcements,
            'authorized_actions': authorized_actions,
            'denied_actions': denied_actions,
            'compliance_rate': authorized_actions / total_enforcements if total_enforcements > 0 else 1.0,
            'default_behaviors': self.default_behaviors,
            'default_boundaries': self.default_boundaries,
            'policies': list(self.policies.values()),
            'agent_purposes': list(self.agent_purposes.values()),
            'recent_enforcements': self.enforcement_log[-10:]  # 10 derni√®res actions
        }
        
        return report


class GovernanceAgent:
    """Agent de gouvernance pour les 2 mesures principales"""
    
    def __init__(self):
        self.governance_tools = GovernanceTools()
        self.api_key = os.getenv("XAI_API_KEY")
        
        # Cr√©er l'agent avec les outils de gouvernance
        self.agent = Agent(
            name="Governance Assistant",
            model=xAI(id="grok-3-mini", api_key=self.api_key),
            tools=[self.governance_tools],
            markdown=True,
            show_tool_calls=True,
            instructions=dedent("""
            Tu es un agent de gouvernance sp√©cialis√© dans la d√©finition et l'application des politiques.
            Ton r√¥le est de :
            1. D√©finir les comportements par d√©faut et les limites d'action
            2. D√©finir clairement le but et les cas d'usage autoris√©s des agents
            
            Toujours prioriser la conformit√© et l'application des politiques.
            """)
        )
    
    def define_agent_purpose(self, agent_id: str, name: str, primary_purpose: str, 
                           authorized_use_cases: List[str], **kwargs) -> AgentPurpose:
        """D√©finit le but et les cas d'usage d'un agent"""
        return self.governance_tools.define_agent_purpose(
            agent_id, name, primary_purpose, authorized_use_cases, **kwargs
        )
    
    def set_default_behavior(self, behavior_type: str, value: Any) -> None:
        """D√©finit un comportement par d√©faut"""
        self.governance_tools.set_default_behavior(behavior_type, value)
    
    def set_boundary(self, boundary_type: str, value: Any) -> None:
        """D√©finit une limite d'action"""
        self.governance_tools.set_boundary(boundary_type, value)
    
    def check_authorization(self, agent_id: str, action: str, context: Dict[str, Any] = None) -> Dict[str, Any]:
        """V√©rifie si une action est autoris√©e pour un agent"""
        return self.governance_tools.check_authorization(agent_id, action, context)
    
    def get_governance_report(self) -> Dict[str, Any]:
        """Obtient le rapport de gouvernance complet"""
        print("üìä RAPPORT DE GOUVERNANCE")
        print("="*50)
        
        report = self.governance_tools.get_governance_report()
        
        print(f"üìú Mesure Politiques totales: {report['total_policies']}")
        print(f"ü§ñ Mesure Agents enregistr√©s: {report['total_agents']}")
        print(f"üîç Mesure Actions v√©rifi√©es: {report['total_enforcements']}")
        print(f"‚úÖ Mesure Actions autoris√©es: {report['authorized_actions']}")
        print(f"‚ùå Mesure Actions refus√©es: {report['denied_actions']}")
        print(f"üìà Mesure Taux de conformit√©: {report['compliance_rate']:.2%}")
        
        return report

# Exemple d'utilisation
if __name__ == "__main__":
    # Cr√©er l'agent de gouvernance
    governance_agent = GovernanceAgent()
    
    print("üõ°Ô∏è AGENT DE GOUVERNANCE - 2 MESURES PRINCIPALES")
    print("="*60)
    
    # Test 1: D√©finir le but et les cas d'usage autoris√©s des agents
    print("\nüìã MESURE 1: INTENDED AGENT PURPOSE")
    print("-" * 40)
    purpose = governance_agent.define_agent_purpose(
        agent_id="security_agent_001",
        name="Agent de S√©curit√©",
        primary_purpose="Protection des donn√©es et d√©tection des menaces",
        authorized_use_cases=[
            "D√©tection de PII",
            "Analyse de s√©curit√©",
            "Audit de conformit√©",
            "Gestion des incidents"
        ],
        prohibited_use_cases=[
            "Acc√®s non autoris√© aux donn√©es",
            "Modification des configurations de s√©curit√©",
            "Bypass des contr√¥les de s√©curit√©"
        ],
        capabilities=[
            "D√©tection de menaces",
            "Analyse de logs",
            "G√©n√©ration de rapports"
        ],
        limitations=[
            "Acc√®s en lecture seule",
            "Pas de modification des syst√®mes",
            "Audit obligatoire des actions"
        ]
    )
    print(f"Mesure But de l'agent d√©fini: {purpose.name}")
    print(f"Mesure Cas d'usage autoris√©s: {len(purpose.authorized_use_cases)}")
    print(f"Mesure Cas d'usage interdits: {len(purpose.prohibited_use_cases)}")
    
    # Test 2: D√©finir les comportements par d√©faut et les limites d'action
    print("\nüìã MESURE 2: DEFAULT BEHAVIOR AND BOUNDARIES")
    print("-" * 40)
    governance_agent.set_default_behavior("response_style", "formal")
    governance_agent.set_default_behavior("safety_level", "maximum")
    governance_agent.set_boundary("max_response_length", 3000)
    governance_agent.set_boundary("max_processing_time", 20)
    print("Mesure Comportements par d√©faut configur√©s")
    print("Mesure Limites d'action d√©finies")
    
    # Test 3: V√©rification d'autorisation
    print("\nüìã MESURE 3: AUTHORIZATION CHECK")
    print("-" * 40)
    auth_result = governance_agent.check_authorization(
        "security_agent_001",
        "Analyser les logs de s√©curit√© pour d√©tecter les intrusions",
        {"user_role": "security_analyst"}
    )
    print(f"Mesure Autorisation: {'‚úÖ Autoris√©' if auth_result['authorized'] else '‚ùå Refus√©'}")
    print(f"Mesure Raison: {auth_result['reason']}")
    
    # Test 4: Rapport de gouvernance
    print("\nüìã MESURE 4: GOVERNANCE REPORT")
    print("-" * 40)
    governance_report = governance_agent.get_governance_report()
    
    print("\n‚úÖ Tests de gouvernance termin√©s!")
    print("="*60)
